<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>View Raw PCAP</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

<!-- Navigation -->
<nav class="bg-blue-600 text-white p-4 flex justify-between items-center">
  <div class="text-xl font-bold">NIDS Dashboard</div>
  <div class="space-x-4 flex items-center relative">
    <a href="home.html" class="hover:underline">Home</a>
    <a href="dashboard.html" class="hover:underline">Dashboard</a>
    <a href="alerts.html" class="hover:underline">Alerts</a>
    <div class="relative group">
      <a href="#" class="hover:underline">Raw PCAP</a>
      <div class="absolute left-0 mt-1 w-40 bg-white text-black rounded shadow-lg opacity-0 group-hover:opacity-100 invisible group-hover:visible transition-opacity duration-300">
        <a href="raw_pcap.html" class="block px-4 py-2 hover:bg-blue-100">View Raw PCAP</a>
        <a href="view_raw_pcap.html" class="block px-4 py-2 hover:bg-blue-100">View PCAP Files</a>
      </div>
    </div>
    <a href="reports.html" class="hover:underline">Reports</a>
  </div>
</nav>

<div class="p-6 max-w-7xl mx-auto space-y-6">

  <h1 class="text-2xl font-bold mb-4">View Raw PCAP Files</h1>

  <!-- Filter controls -->
  <div class="flex flex-col md:flex-row md:items-center md:space-x-4 mb-4 space-y-2 md:space-y-0">
    <input type="text" id="searchInput" placeholder="Search by filename..." 
           class="border border-gray-300 rounded px-3 py-2 w-full md:w-1/2">
    <input type="date" id="dateInput" class="border border-gray-300 rounded px-3 py-2 w-full md:w-1/3">
    <button id="resetFilter" class="px-3 py-2 bg-gray-300 rounded hover:bg-gray-400 w-full md:w-auto">Reset Filters</button>
  </div>

  <!-- File list -->
  <div id="fileListContainer" class="bg-white rounded-lg shadow p-4 max-h-96 overflow-y-auto">
    <h2 class="text-lg font-bold mb-2">Available PCAP Files</h2>
    <ul id="fileList" class="space-y-1"></ul>
  </div>

  <!-- PCAP content table -->
  <div id="pcapContainer" class="hidden bg-white rounded-lg shadow p-4">
    <div class="flex justify-between mb-2 items-center">
      <h2 class="text-lg font-bold">PCAP Content: <span id="currentFile"></span> (<span id="packetCount">0</span> packets)</h2>
      <button id="backToList" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">Back</button>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white rounded-lg shadow border border-gray-300">
        <thead class="bg-gray-200 border-b border-gray-300 sticky top-0 z-10">
          <tr>
            <th class="py-2 px-4 text-left border-b border-gray-300">Time</th>
            <th class="py-2 px-4 text-left border-b border-gray-300">Source</th>
            <th class="py-2 px-4 text-left border-b border-gray-300">Destination</th>
            <th class="py-2 px-4 text-left border-b border-gray-300">Protocol</th>
            <th class="py-2 px-4 text-left border-b border-gray-300">Length</th>
            <th class="py-2 px-4 text-left border-b border-gray-300">Info</th>
          </tr>
        </thead>
        <tbody id="pcapTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Notification container -->
  <div id="notification-container" class="fixed top-16 right-4 space-y-2 z-50"></div>
</div>

<script>
const fileListContainer = document.getElementById("fileListContainer");
const pcapContainer = document.getElementById("pcapContainer");
const fileList = document.getElementById("fileList");
const pcapTable = document.getElementById("pcapTable");
const currentFileSpan = document.getElementById("currentFile");
const backToListBtn = document.getElementById("backToList");
const searchInput = document.getElementById("searchInput");
const dateInput = document.getElementById("dateInput");
const resetBtn = document.getElementById("resetFilter");
const packetCountSpan = document.getElementById("packetCount");

function showNotification(msg, type="info", duration=3000){
    const container = document.getElementById("notification-container");
    const colors = {info:"bg-blue-500", success:"bg-green-500", warning:"bg-yellow-500", error:"bg-red-500"};
    const notification = document.createElement("div");
    notification.className = `text-white ${colors[type]} px-5 py-3 rounded shadow-lg text-sm md:text-base`;
    notification.textContent = msg;
    container.appendChild(notification);
    setTimeout(()=>{notification.remove()}, duration);
}

let currentFiles = [];

function filterFiles(files){
    const searchText = searchInput.value.toLowerCase();
    const selectedDate = dateInput.value.replaceAll("-", ""); // YYYYMMDD

    return files.filter(f => {
        const matchesSearch = f.toLowerCase().includes(searchText);
        const matchesDate = selectedDate ? f.includes(selectedDate) : true;
        return matchesSearch && matchesDate;
    });
}

function renderFileList(files){
    const filtered = filterFiles(files);
    fileList.innerHTML = "";
    filtered.forEach(f=>{
        const li = document.createElement("li");
        li.className = "p-2 border-b cursor-pointer hover:bg-gray-100";
        li.textContent = f;
        li.addEventListener("click", ()=>loadPcap(f));
        fileList.appendChild(li);
    });
}

// Reset filters
resetBtn.addEventListener("click", () => {
    searchInput.value = "";
    dateInput.value = "";
    renderFileList(currentFiles);
});

searchInput.addEventListener("input", () => renderFileList(currentFiles));
dateInput.addEventListener("change", () => renderFileList(currentFiles));

// Fetch file list
async function loadFiles() {
    try {
        const res = await fetch("/list_pcaps");
        if(!res.ok) throw new Error("Failed to fetch file list");
        const files = await res.json();
        currentFiles = files;
        renderFileList(files);
    } catch(err) {
        showNotification(err.message,"error");
    }
}

// Load selected PCAP content
async function loadPcap(filename){
    try{
        const res = await fetch(`/get_pcap?file=${encodeURIComponent(filename)}`);
        if(!res.ok) throw new Error("Failed to fetch PCAP content");
        const packets = await res.json();

        fileListContainer.classList.add("hidden");
        pcapContainer.classList.remove("hidden");
        currentFileSpan.textContent = filename;
        packetCountSpan.textContent = packets.length;
        pcapTable.innerHTML = "";

        packets.forEach((pkt, index)=>{
            const cleanInfo = pkt.info.replace(/\x1b\[[0-9;]*m/g, '');
            const formattedInfo = cleanInfo.split(/\r?\n/).map(line => line.trim() ? `&nbsp;&nbsp;&nbsp;${line}` : '').join('<br>');

            const row = document.createElement("tr");
            row.className = `border-b border-gray-200 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} hover:bg-blue-100`;
            row.innerHTML = `
                <td class="py-1 px-2 border-b border-gray-200">${pkt.time}</td>
                <td class="py-1 px-2 border-b border-gray-200">${pkt.src}</td>
                <td class="py-1 px-2 border-b border-gray-200">${pkt.dst}</td>
                <td class="py-1 px-2 border-b border-gray-200">${pkt.protocol}</td>
                <td class="py-1 px-2 border-b border-gray-200">${pkt.length}</td>
                <td class="py-1 px-2 border-b border-gray-200 break-words max-w-lg whitespace-pre-wrap font-mono">${formattedInfo}</td>`;
            pcapTable.appendChild(row);
        });
    } catch(err){
        showNotification(err.message,"error");
    }
}

backToListBtn.addEventListener("click", ()=>{
    pcapContainer.classList.add("hidden");
    fileListContainer.classList.remove("hidden");
});

// Initial load
loadFiles();
</script>
</body>
</html>
